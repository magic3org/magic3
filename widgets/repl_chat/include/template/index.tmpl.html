/**
 * 表示データ作成用テンプレート(patTemplate)
 *
 * LICENSE: This source file is licensed under the terms of the GNU General Public License.
 *
 * @package    Magic3 Framework
 * @author     平田直毅(Naoki Hirata) <naoki@aplo.co.jp>
 * @copyright  Copyright 2006-2018 Magic3 Project.
 * @license    http://www.gnu.org/copyleft/gpl.html  GPL License
 * @version    SVN: $Id$
 * @link       http://www.magic3.org
 */
<patTemplate:tmpl name="_widget">
<script type="text/javascript">
//<![CDATA[
$(function(){
	// FontAwesomeのクラスが未定義の場合は動的にCSSを読み込む
	var faSpan = $('<span class="fa" style="display:none"></span>').appendTo('body');
	var fontFamily = faSpan .css('font-family');
	if (fontFamily.indexOf('Font Awesome') == -1){
		var style = '<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">';
		$('head link:last').after(style);
	}
	faSpan.remove();

	var html = '';
	html += '<div id="repl_chat">';
	html += '<div class="row border-chat">';
	html += '<div class="col-md-12 col-sm-12 col-xs-12 first-section">';
	html += '<div class="row">';
	html += '<div class="col-md-8 col-sm-6 col-xs-6 left-first-section">';
	html += '<p>Chat</p>';
	html += '</div>';
	html += '<div class="col-md-4 col-sm-6 col-xs-6 right-first-section">';
	html += '<a href="javascript:void(0);" id="chat_open_panel"><i class="fa fa-minus" aria-hidden="true"></i></a>';
	html += '</div>';
	html += '</div>';
	html += '</div>';
	html += '</div>';
	html += '<div class="row border-chat">';
	html += '<div class="col-md-12 col-sm-12 col-xs-12 second-section">';
	html += '<div class="chat-section">';
	html += '<ul>';
	html += '</ul>';
	html += '</div>';
	html += '</div>';
	html += '</div>';
	html += '<div class="row border-chat">';
	html += '<div class="third-section text-bar">';
	html += '<input type="text" id="chat_message" placeholder="メッセージをどうぞ">';
	html += '</div>';
	html += '<div class="text-right text-bar-icon"><a href="javascript:void(0);" id="chat_sendmessage"><i class="fa fa-arrow-right" aria-hidden="true"></i></a></div>';
	html += '</div>';
	html += '</div>';
	$("body").append(html);
	
	$(".left-first-section").click(function(){
	    $('#repl_chat').toggleClass("open-more");
	});
	$("#chat_open_panel").click(function(){
	    $('#repl_chat').toggleClass("open-more");
	});
	$("#chat_sendmessage").click(function(){
		var message = $('#chat_message').val();
		if (message == '') return;
		
		m3_ajax_request('', 'act=chatmsg&message=' + message, function(request, retcode, jsondata){		// 正常終了
			// 返答メッセージを表示
			/*if (jsondata.message){
				if (jsondata.message != '') alert(jsondata.message);
			}*/
			$('#chat_message').val('');
		}, function(request){		// 異常終了
			alert('通信に失敗しました。');
		});
	});
	
	// チャット初期化
	m3_ajax_request('', 'act=chatinit', function(request, retcode, jsondata){		// 正常終了
		// 返答メッセージを表示
		/*if (jsondata.message){
			if (jsondata.message != '') alert(jsondata.message);
		}*/
	}, function(request){		// 異常終了
		alert('通信に失敗しました。');
	});
});
//]]>
</script>
</patTemplate:tmpl>
