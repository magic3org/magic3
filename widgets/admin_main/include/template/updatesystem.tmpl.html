/**
 * 表示データ作成用テンプレート(patTemplate)
 *
 * LICENSE: This source file is licensed under the terms of the GNU General Public License.
 *
 * @package    Magic3 Framework
 * @author     平田直毅(Naoki Hirata) <naoki@aplo.co.jp>
 * @copyright  Copyright 2006-2020 Magic3 Project.
 * @license    http://www.gnu.org/copyleft/gpl.html  GPL License
 * @version    SVN: $Id$
 * @link       http://www.magic3.org
 */
<patTemplate:tmpl name="_widget">
<script type="text/javascript">
//<![CDATA[
function updateSystem(){
	if (!window.confirm('システムを最新にアップデートしますか?')) return false;
	
	// ボタン使用不可
	$("#update_button").prop('disabled', true);
	
	// メッセージを初期化
	$('#step_message').empty();
	
	// 処理中ダイアログ表示
	m3ShowProcessModal();
	
	$('#step_message').append('<li>アップデート開始</li>');
	
	// バージョンアップ情報取得
	m3_ajax_request('', 'task=updatesystem&act=updatebystep&step=1', function(request, retcode, jsondata){		// 正常終了
		if (jsondata.code == '0'){	// エラーの場合
			// 処理中ダイアログ停止
			m3HideProcessModal();
		
			alert('アップデートに失敗しました。');
			return;
		}
		
		// 正常に終了の場合はメッセージを追加
		$('#step_message').append('<li>' + jsondata.message + '</li>');
	
		m3_ajax_request('', 'task=updatesystem&act=updatebystep&step=2', function(request, retcode, jsondata){		// 正常終了
			if (jsondata.code == '0'){	// エラーの場合
				// 処理中ダイアログ停止
				m3HideProcessModal();
			
				alert('アップデートに失敗しました。');
				return;
			}
			
			// 正常に終了の場合はメッセージを追加
			$('#step_message').append('<li>' + jsondata.message + '</li>');
			
			m3_ajax_request('', 'task=updatesystem&act=updatebystep&step=3', function(request, retcode, jsondata){		// 正常終了
				if (jsondata.code == '0'){	// エラーの場合
					// 処理中ダイアログ停止
					m3HideProcessModal();
			
					alert('アップデートに失敗しました。');
					return;
				}
			
				// 正常に終了の場合はメッセージを追加
				$('#step_message').append('<li>' + jsondata.message + '</li>');
			
				m3_ajax_request('', 'task=updatesystem&act=updatebystep&step=4', function(request, retcode, jsondata){		// 正常終了
					if (jsondata.code == '0'){	// エラーの場合
						// 処理中ダイアログ停止
						m3HideProcessModal();
			
						alert('アップデートに失敗しました。');
						return;
					}
			
					// 正常に終了の場合はメッセージを追加
					$('#step_message').append('<li>' + jsondata.message + '</li>');
			
					// 処理中ダイアログ停止
					m3HideProcessModal();
				}, function(request){		// 異常終了
					// 処理中ダイアログ停止
					m3HideProcessModal();
		
					alert('通信に失敗しました。');
				});
			}, function(request){		// 異常終了
				// 処理中ダイアログ停止
				m3HideProcessModal();
		
				alert('通信に失敗しました。');
			});
		}, function(request){		// 異常終了
			// 処理中ダイアログ停止
			m3HideProcessModal();
		
			alert('通信に失敗しました。');
		});
	}, function(request){		// 異常終了
		// 処理中ダイアログ停止
		m3HideProcessModal();
		
		alert('通信に失敗しました。');
	});
}
//]]>
</script>
<div class="m3config_container">
<!-- m3:ErrorMessage -->
<form method="post" name="main" class="form form-inline">
<input type="hidden" name="act" />
<input type="hidden" name="develop" value="{DEVELOP}" />
<div class="panel panel-info" style="width:500px;margin:20px auto;" >
    <div class="panel-heading">システム</div>
    <ul class="list-group">
        <li class="list-group-item">アップデート可能なバージョン：{VER_STR}</li>
    </ul>
    <div class="panel-footer"><input type="button" id="update_button" class="button" onclick="updateSystem();" value="実行" {BUTTON_DISABLED} /></div>
</div>
</form>
<ol id="step_message">
</ol>
</div>
</patTemplate:tmpl>
