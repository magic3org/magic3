/**
 * 表示データ作成用テンプレート(patTemplate)
 *
 * LICENSE: This source file is licensed under the terms of the GNU General Public License.
 *
 * @package    Magic3 Framework
 * @author     平田直毅(Naoki Hirata) <naoki@aplo.co.jp>
 * @copyright  Copyright 2006-2015 Magic3 Project.
 * @license    http://www.gnu.org/copyleft/gpl.html  GPL License
 * @version    SVN: $Id$
 * @link       http://www.magic3.org
 */
<patTemplate:tmpl name="_widget">
<script type="text/javascript">
//<![CDATA[
function updateItem(){
	if (!window.confirm('設定を更新しますか?')) return false;
	document.main.act.value='update';
	document.main.submit();
	return true;
}
function cancelItem(){
	document.main.task.value = 'entry_detail';
	document.main.submit();
	return true;
}
function initJcrop()
{
	var jcrop_api,
		boundx,
		boundy,

		// Grab some information about the preview pane
		$preview = $('#preview-pane'),
		$pcnt = $('#preview-pane .preview-container'),
		$pimg = $('#preview-pane .preview-container img'),

		xsize = $pcnt.width(),
		ysize = $pcnt.height();

	$('#target').Jcrop({
		/*			keySupport: false,*/
		onChange: updatePreview,
		onSelect: updatePreview,
		aspectRatio: xsize / ysize
	},function(){
		// Use the API to get the real image size
		var bounds = this.getBounds();
		boundx = bounds[0];
		boundy = bounds[1];
		// Store the API in the jcrop_api variable
		jcrop_api = this;

		// Move the preview into the jcrop container for css positioning
		$preview.appendTo(jcrop_api.ui.holder);

		$preview.show();
	});

	function updatePreview(c)
	{
		if (parseInt(c.w) > 0)
		{
			var rx = xsize / c.w;
			var ry = ysize / c.h;

			$pimg.css({
				width: Math.round(rx * boundx) + 'px',
				height: Math.round(ry * boundy) + 'px',
				marginLeft: '-' + Math.round(rx * c.x) + 'px',
				marginTop: '-' + Math.round(ry * c.y) + 'px'
			});
		}
	};
}
// 画像作成用ダイアログ表示
function createEyecatch(url)
{
//	var dialogText = '<img src="{DEFAULT_EYECATCH_URL}" id="target" alt="selected image" />';
	var dialogText = '<p>画像から切り取る領域を選択してください</p>';
	dialogText += '<img src="' + url + '" id="target" alt="selected image" />';
	dialogText += '<div id="preview-pane" style="display:none;">';
	dialogText += '<div class="preview-container">';
//	dialogText += '<img id="preview" src="{DEFAULT_EYECATCH_URL}" class="jcrop-preview" alt="Preview" />';
	dialogText += '<img id="preview" src="' + url + '" class="jcrop-preview" alt="Preview" />';
	dialogText += '</div>';
	dialogText += '</div>';
		
	// ダイアログ作成
	BootstrapDialog.show({
		title: '画像の部分選択',
		message: dialogText,
		closable: false,
		nl2br: false,
		onshown: function(dialog) {		// 起動時の処理
			// 画像の部分選択機能作成
			initJcrop();
		},
		buttons: [{
			id: 'cancel',
			label: 'キャンセル',
			action: function(dialog) {
				dialog.close();
			}
		}, {
			id: 'ok',
			label: 'OK',
			cssClass: 'btn-primary',
			action: function(dialog) {
				dialog.close();
			}
		}]
	});
}
// ファイルブラウザからの設定用
function SetUrl(url)
{
	// 画像部分選択用ダイアログ表示
	createEyecatch(url);
}
$(function()
{
	// CKEditorプラグイン直接実行
	m3LoadCKTools();
	
	m3SetConfigTable('config_area');
	
	// 画像作成ボタンの処理
	$("#{TAGID_CREATE_EYECATCH}").click(function (){
		m3OpenImageFileBrowser(SetUrl);		// 画像選択
	});
});
//]]>
</script>
<style type="text/css">
#target {
        max-height:400px;
        max-width:400px;
        height: auto!important;
        width: auto!important;
}
/* Apply these styles only when #preview-pane has
   been placed within the Jcrop widget */
.jcrop-holder #preview-pane {
  display: block;
  position: absolute;
  z-index: 2000;
  top: 5px;
  right: -140px;
  padding: 6px;
  border: 1px rgba(0,0,0,.4) solid;
  background-color: white;

  -webkit-border-radius: 6px;
  -moz-border-radius: 6px;
  border-radius: 6px;

  -webkit-box-shadow: 1px 1px 5px 2px rgba(0, 0, 0, 0.2);
  -moz-box-shadow: 1px 1px 5px 2px rgba(0, 0, 0, 0.2);
  box-shadow: 1px 1px 5px 2px rgba(0, 0, 0, 0.2);
}

/* The Javascript code will set the aspect ratio of the crop
   area based on the size of the thumbnail preview,
   specified here */
#preview-pane .preview-container {
/*  width: 250px;
  height: 170px;*/
  width:100px;
  height:100px;
  overflow: hidden;
}
</style>
<div class="m3config_container">
<!-- m3:ErrorMessage -->
<form method="post" name="main">
<input type="hidden" name="task" value="image" />
<input type="hidden" name="act" />
<input type="hidden" name="entryid" value="{ENTRY_ID}" />
<!-- m3:PostParam -->
<h3 class="m3config_h"><span {_HELP_IMAGE_IMAGE}>ブログ記事画像</span></h3>
<div class="m3config_h_side_buttons pull-right"><div {_HELP_IMAGE_BUTTONS}><div class="btn-group">
    <input type="button" class="button" onclick="cancelItem();" value="戻る" />
</div></div></div>
<table id="config_area">
    <tbody>
    <tr>
	    <th><span {_HELP_IMAGE_EYECATCH}>アイキャッチ画像<br />{EYECATCH_SIZE}</span><div class="pull-right">{CREATE_EYECATCH_BUTTON}</div></th>
	    <td><img id="sitelogo_preview" class="pull-left" src="{EYECATCH_URL}" /><div class="pull-right"><div id="uploader_sitelogo">{UPLOAD_AREA}</div></div></td>
	</tr>
    </tbody>
</table>
<div class="well m3config_update_buttons"><input type="button" class="button" onclick="updateItem();" value="更新" /></div>
</form>
</div>
</patTemplate:tmpl>
