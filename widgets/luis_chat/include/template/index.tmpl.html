/**
 * 表示データ作成用テンプレート(patTemplate)
 *
 * LICENSE: This source file is licensed under the terms of the GNU General Public License.
 *
 * @package    Magic3 Framework
 * @author     平田直毅(Naoki Hirata) <naoki@aplo.co.jp>
 * @copyright  Copyright 2006-2018 Magic3 Project.
 * @license    http://www.gnu.org/copyleft/gpl.html  GPL License
 * @version    SVN: $Id$
 * @link       http://www.magic3.org
 */
<patTemplate:tmpl name="_widget">
<script type="text/javascript">
//<![CDATA[
$(function(){
	var initCompleted = false;		// 初期化状態
	var html = '';
/*	html += '<div id="repl_chat">';
	html += '<div class="border-chat">';
	html += '<div class="first-section">';
	html += '<div class="">';
	html += '<div class="left-first-section">';
	html += '<p>Chat</p>';
	html += '</div>';
	html += '<div class="right-first-section">';
	html += '<a href="javascript:void(0);" id="chat_open_panel"><i class="fa fa-minus" aria-hidden="true"></i></a>';
	html += '</div>';
	html += '</div>';
	html += '</div>';
	html += '</div>';
	html += '<div class="border-chat">';
	html += '<div class="second-section">';
	html += '<div id="chat-section" class="chat-section">';
	html += '<ul id="chat_body">';
	html += '</ul>';
	html += '</div>';
	html += '</div>';
	html += '</div>';
	html += '<div class="border-chat">';
	html += '<div class="third-section text-bar">';
	html += '<form action="#" method="post" id="chat_form">';
	html += '<input type="hidden" id="chat_token" value="{TOKEN}">';
	html += '<input type="text" id="chat_message" placeholder="メッセージをどうぞ">';
	html += '</form>';
	html += '</div>';
	html += '<div class="text-right text-bar-icon"><a href="javascript:void(0);" id="chat_sendmessage"><i class="fa fa-arrow-right" aria-hidden="true"></i></a></div>';
	html += '</div>';
	html += '</div>';*/
	
	html += '<div id="m3chatbox" class="chatbox-tray">';
	html += '<div class="panel panel-primary">';
	html += '<div class="panel-heading chatbox-title">';
	html += '<h1 class="panel-title">チャットサービス</h1>';
	html += '<span class="pull-right clickable chatbox-close"><i class="glyphicon glyphicon glyphicon-remove"></i></span>';
	html += '<span class="pull-right clickable chatbox-min"><i class="glyphicon glyphicon-minus"></i></span>';
	html += '</div>';
	html += '<div id="chat-section" class="panel-body">';
	html += '</div>';
	html += '<div class="panel-footer">';
	html += '<form action="#" method="post">';
	html += '<input type="hidden" id="chat_token" value="{TOKEN}">';
	html += '<div class="input-group">';
	html += '<input type="text" name="message" placeholder="メッセージを入力してください" class="form-control">';
	html += '<span class="input-group-btn">';
	html += '<button type="submit" class="btn btn-primary btn-flat">送信</button>';
	html += '</span>';
	html += '</div>';
	html += '</form>';
	html += '</div>';
	html += '</div>';
	html += '</div>';
	$("body").append(html);

	// チャット初期処理
	function init()
	{
		if (initCompleted) return;		// 初期化状態

		// チャット初期化
		m3_ajax_request('{WIDGET_ID}', 'act=chatinit&token=' + $('#chat_token').val(), function(request, retcode, jsondata){		// 正常終了
			// 返答メッセージを表示
			if (jsondata.message){
				if (jsondata.message != ''){
					var messageHtml = '';
					messageHtml += '<li>';
					messageHtml += '<div class="left-chat">';
					messageHtml += '<img src="{BOT_AVATAR}">';
					messageHtml += '<p>' + jsondata.message + '</p>';
					//messageHtml += '<span>2 min</span>
					messageHtml += '</div>';
					messageHtml += '</li>';
					//$("#chat_body").append(messageHtml);
					$("#chat-section").append(messageHtml);
					$('#chat-section').animate({scrollTop: $('#chat-section')[0].scrollHeight}, 'fast');
				}
			}
			initCompleted = true;			// 初期化終了
		}, function(request){		// 異常終了
			alert('通信に失敗しました。');
		});
	}
	
	// メッセージ送信
	function send()
	{
		var message = $('#chat_message').val();
		if (message == '') return;
		
		var messageHtml = '';
		messageHtml += '<li>';
		messageHtml += '<div class="right-chat">';
		messageHtml += '<img src="{GUEST_AVATAR}">';
		messageHtml += '<p>' + message + '</p>';
		//messageHtml += '<span>2 min</span>';
		messageHtml += '</div>';
		messageHtml += '</li>';
		$("#chat_body").append(messageHtml);
		$('#chat-section').animate({scrollTop: $('#chat-section')[0].scrollHeight}, 'fast');
					
		m3_ajax_request('{WIDGET_ID}', 'act=chatmsg&token=' + $('#chat_token').val() + '&message=' + message, function(request, retcode, jsondata){		// 正常終了
			// 返答メッセージを表示
			if (jsondata.message){
				if (jsondata.message != ''){
					messageHtml = '';
					messageHtml += '<li>';
					messageHtml += '<div class="left-chat">';
					messageHtml += '<img src="{BOT_AVATAR}">';
					messageHtml += '<p>' + jsondata.message + '</p>';
					//messageHtml += '<span>2 min</span>
					messageHtml += '</div>';
					messageHtml += '</li>';
					$("#chat_body").append(messageHtml);
					$('#chat-section').animate({scrollTop: $('#chat-section')[0].scrollHeight}, 'slow');
				}
			}
			$('#chat_message').val('');
		}, function(request){		// 異常終了
			alert('通信に失敗しました。');
		});
	}
		
	var $chatbox = $('#m3chatbox');
	var $chatboxTitle = $('.chatbox-title');
	var $chatboxTitleClose = $('.chatbox-close');
	$chatboxTitle.on('click', function() {
		$chatbox.toggleClass('chatbox-tray');
	});
	$chatboxTitleClose.on('click', function(e) {
		$chatbox.addClass('chatbox-closed');
	});
	$chatbox.on('transitionend', function() {
		if ($chatbox.hasClass('chatbox-closed')) $chatbox.remove();
	});
	
	// メッセージ送信処理
	$("#chat_sendmessage").click(function(){
		send();
	});
	$('#chat_form').submit(function(){
		send();
		return false;			// SUBMITは行わない
	});
	
<patTemplate:tmpl name="show_panel_open" visibility="hidden">
	// チャット開始
	init();
	
	// パネルオープンで起動
	setTimeout(function(){
		$chatbox.toggleClass('chatbox-tray');
	}, 500);
</patTemplate:tmpl>
});
//]]>
</script>
</patTemplate:tmpl>
